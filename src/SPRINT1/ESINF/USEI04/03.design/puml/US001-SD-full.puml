@startuml

title USEI04 - Design Sequence Diagram (Corrected)

skinparam packageStyle rectangle
skinparam shadowing false
autonumber

actor "Picker" as Picker
participant ":GetPickingPathUI" as UI
participant ":GetPickingPathController" as CTR
participant ":PickingPlanValidator" as Validator
participant ":PathSequencingService" as Service
participant "Repositories" as REPOS
participant "repositories\n:Repositories" as REPOS_SINGLETON
participant ":PickingPathRepository" as Repo
participant ":PickingPath" as Path

activate UI
    UI --> Picker: Displays option to plan a picking path
    activate Picker
        Picker -> UI: Requests optimized path for a picking plan

        UI --> CTR** : create()
        UI -> CTR: getOptimizedPath(plan)
        activate CTR
            CTR -> Validator: validate(plan)
            activate Validator
                alt Invalid Picking Plan
                    Validator --> CTR: false (invalid)
                    deactivate Validator
                    CTR --> UI: return error ("Invalid Plan")
                    UI --> Picker: Displays error message
                else Valid Picking Plan
                    Validator --> CTR: true (valid)
                    deactivate Validator

                    CTR -> Service: calculatePaths(plan)
                    activate Service
                        ' Internal service logic to find best paths
                        Service -> Service: mergeDuplicateBays()
                        Service -> Service: calculateStrategyA()
                        Service -> Service: calculateStrategyB()
                        Service --> CTR: pathCalculationResults
                    deactivate Service

                    CTR -> REPOS : getInstance()
                    activate REPOS
                        REPOS --> CTR: repositories
                    deactivate REPOS

                    CTR -> REPOS_SINGLETON : getPickingPathRepository()
                    activate REPOS_SINGLETON
                        REPOS_SINGLETON --> CTR: PickingPathRepository
                    deactivate REPOS_SINGLETON

                    CTR -> Repo : createAndSavePath(pathCalculationResults)
                    activate Repo
                        Repo -> Path** : create(pathData)
                        ' Internal logic to save the new Path object to the database
                        Repo --> CTR : savedPickingPath
                    deactivate Repo

                    CTR --> UI : savedPickingPath
                    UI --> Picker: Displays both optimized paths and distances
                end
        deactivate CTR
    deactivate Picker
deactivate UI

@enduml